$(document).ready(function() {
    let msgurl = "./msg";
    let upd_singleton = 0;
    
   const render = function() {       
    if((typeof window.localStorage.getItem('msg') !== 'undefined') && (window.localStorage.getItem('msg') !== null)) {
        let data = JSON.parse(window.localStorage.getItem('msg'));            
        if(typeof data.depot !== "undefined") {
            $('#gsbInfo').correntlySKOBalance(data.depot.account);
            $('#depot').correntlySKODepot(data.depot.account);
            $('#customsko').correntlyTreeBalance(data.depot.account);
            $('#hknchart').correntlyHKNChart(data.meterinfo.location.zip);
        }
        
        let daterow = "<tr><td class='small'>&#128197;</td>";
        let barrow = "<tr><td class='small'>&nbsp;</td>";
        let timerow="<tr><td class='small'>&#128336;</td>";
        let gimerow="<tr><td class='small'>&#128336;</td>";
        let garrow = "<tr><td class='small'>&nbsp;</td>";
        for(var i=0;(i<data.stats.next24h.prodWh.length);i++) {
            let date = new Date(data.stats.next24h.prodWh[i].time);
            if((i==0)||(date.getHours()==0)) {
                daterow+="<td class='small tsclass' colspan='3'>"+date.getDate()+"."+(date.getMonth()+1)+"</td>";
             } else daterow+="<td>&nbsp;</td>";   
            let bgclass="bg-warning";
            if(data.stats.next24h.prodWh[i].nsi<48) bgclass="bg-secondary";
            if(data.stats.next24h.prodWh[i].nsi>52) bgclass="bg-success";
            barrow+="<td style='vertical-align:bottom' class='tsclass'><div class='"+bgclass+"' title='Indexwert: "+data.stats.next24h.prodWh[i].nsi+" Punkte' style=';height:"+Math.round((data.stats.next24h.prodWh[i].nsi)*2)+"px'></div></td>";
            timerow+="<td  class='"+bgclass+" tsclass small' style='text-align:right'>"+date.getHours()+":00</td>";
            
            bgclass="bg-warning";
            if(data.stats.next24h.prodWh[i].gsi<48) bgclass="bg-secondary";
            if(data.stats.next24h.prodWh[i].gsi>52) bgclass="bg-success";
            garrow+="<td style='vertical-align:bottom' class='tsclass'><div class='"+bgclass+"' title='Indexwert: "+data.stats.next24h.prodWh[i].gsi+" Punkte' style=';height:"+Math.round((data.stats.next24h.prodWh[i].gsi)*2)+"px'></div></td>";
            gimerow+="<td  class='"+bgclass+" tsclass small' style='text-align:right'>"+date.getHours()+":00</td>";           
        }
        
        daterow+="</tr>";
        barrow+="</tr>";
        timerow+="</tr>";
        $('#nsiChart').html("<table class='table table-sm table-responsive gsiDataGiven'>"+barrow+daterow+timerow+"</table>");
        $('#gsiChart').html("<table class='table table-sm table-responsive gsiDataGiven'>"+garrow+daterow+gimerow+"</table>");

        $('#btnSchedule').click(function() {
           $('#schedule').modal(); 
        });
        let matrixhtml = '<table class="table table-sm table-responsive">';
        matrixhtml += '<tr><th>Stunden</th><th>Einschalten</th><th>Ausschalten</th></tr>';
        for(let j=1;j<12;j++) {
            let maxGsi = -999;
            let timeStamp = 0;
            for(let x=0;x<24;x++) {
                let sum = 0;
                for(let y=0;y<j;y++) {
                   sum += data.stats.next24h.prodWh[x+y].nsi; 
                }
                if(sum > maxGsi ) {
                    maxGsi = sum;
                    timeStamp = 
                }
            }
            for(let i=0;(i<24);i++) {
                if(matrix['h_'+i]['avg_'+j] > maxGsi) {
                  maxGsi = matrix['h_'+i]['avg_'+j];
                  timeStamp =  data.stats.next24h.prodWh[i].time;
                }
            }
            
            let row = '<tr>';
            row+='<td>' + j +"</td>";
            row+='<td>' + new Date(timeStamp - (3600000 * j)).toLocaleDateString()+ " " + new Date(timeStamp- (3600000 * j)).toLocaleTimeString()+ "</td>";
            row+='<td>' + new Date(timeStamp).toLocaleDateString() + " " + new Date(timeStamp).toLocaleTimeString() + "</td>";                        
            for(let i=0;((i<32)&&(i<data.stats.next24h.prodWh.length));i++) {
                if((data.stats.next24h.prodWh[i].time  - (3600000 * j) >= timeStamp) && (data.stats.next24h.prodWh[i].time <= timeStamp)) {
                    row+="<td style='background:rgb(12,109,52);'>&nbsp;</td>";
                } else {
                    row+="<td style='background:rgb(253,168,37);'>&nbsp;</td>";
                }
            }            
            row+="</tr>";            
            matrixhtml += '' + row;
        }  
        matrixhtml+='</table>';
        $('#matrix').html(matrixhtml);        
    }      
   };
       
    const update = function() { 
       
    if((typeof window.localStorage.getItem('cid') !== 'undefined') &&(window.localStorage.getItem('cid')!==null)){
        msgurl='./p2p?method=msg&peer='+window.localStorage.getItem('cid');
    } else {
        msgurl='./msg';
    }       
       if((upd_singleton > 20) || (upd_singleton==0)) {
          
           $.getJSON(msgurl,function(data) {       
               window.localStorage.setItem('msg',JSON.stringify(data));
               upd_singleton=0;
               render();
           });     
       }
        upd_singleton++;
   }
   
   update();
   setInterval(update,900000);
})