$(document).ready((function(){let t="./msg",e=0;const s=function(){if(void 0!==window.localStorage.getItem("msg")&&null!==window.localStorage.getItem("msg")){let e=JSON.parse(window.localStorage.getItem("msg"));void 0!==e.depot&&($("#gsbInfo").correntlySKOBalance(e.depot.account),$("#depot").correntlySKODepot(e.depot.account),$("#customsko").correntlyTreeBalance(e.depot.account),$("#hknchart").correntlyHKNChart(e.meterinfo.location.zip));let s="<tr><td class='small'>&#128197;</td>",a="<tr><td class='small'>&nbsp;</td>",l="<tr><td class='small'>&#128336;</td>",n="<tr><td class='small'>&#128336;</td>",o="<tr><td class='small'>&nbsp;</td>";if(void 0!==e.stats.next24h.prodWh){for(var t=0;t<e.stats.next24h.prodWh.length;t++){let i=new Date(e.stats.next24h.prodWh[t].time);0==t||0==i.getHours()?s+="<td class='small tsclass' colspan='3'>"+i.getDate()+"."+(i.getMonth()+1)+"</td>":s+="<td>&nbsp;</td>";let r="bg-warning";e.stats.next24h.prodWh[t].nsi<48&&(r="bg-secondary"),e.stats.next24h.prodWh[t].nsi>52&&(r="bg-success"),a+="<td style='vertical-align:bottom' class='tsclass'><div class='"+r+"' title='Indexwert: "+e.stats.next24h.prodWh[t].nsi+" Punkte' style=';height:"+Math.round(2*e.stats.next24h.prodWh[t].nsi)+"px'></div></td>",l+="<td  class='"+r+" tsclass small' style='text-align:right'>"+i.getHours()+":00</td>",r="bg-warning",e.stats.next24h.prodWh[t].gsi<48&&(r="bg-secondary"),e.stats.next24h.prodWh[t].gsi>52&&(r="bg-success"),o+="<td style='vertical-align:bottom' class='tsclass'><div class='"+r+"' title='Indexwert: "+e.stats.next24h.prodWh[t].gsi+" Punkte' style=';height:"+Math.round(2*e.stats.next24h.prodWh[t].gsi)+"px'></div></td>",n+="<td  class='"+r+" tsclass small' style='text-align:right'>"+i.getHours()+":00</td>"}s+="</tr>",a+="</tr>",l+="</tr>",$("#nsiChart").html("<table class='table table-sm table-responsive gsiDataGiven'>"+a+s+l+"</table>"),$("#gsiChart").html("<table class='table table-sm table-responsive gsiDataGiven'>"+o+s+n+"</table>"),$("#btnSchedule").click((function(){$("#schedule").modal()})),$("#btnLoadSchedule").click((function(){const t=function(){let t=e.stats.next24h.prodWh.slice(0,$("#reqHours").val()),s=0,a=0;for(let e=0;e<t.length;e++)t[e].energy>0?(s+=t[e].nsi,a++):t[e].mode="undefined";let l=0;for(let e=0;e<t.length;e++)0==t[e].energy?t[e].mode="disabled":(l++,t[e].nsi<s/a?t[e].mode="follow":t[e].mode="max");if(l<3){let e=t.slice();e.sort((t,e)=>t.gsi<e.gsi?1:-1);for(let s=0;s<e.length&&s<3-l;s++)for(let a=0;a<t.length;a++)t[a].time==e[s].time&&(t[a].mode="enabled")}let n='<table class="table table-condensed table-striped">';n+="<tr><th>Uhrzeit</th><th>Lademodus</th></tr>";let o="";for(let e=0;e<t.length;e++)o!==t[e].mode&&(o=t[e].mode,n+="<tr>",n+="<td>",n+=new Date(t[e].time).toLocaleDateString(),n+=" ",n+=new Date(t[e].time).getHours()+":00",n+="</td>",n+="<td>","disabled"==t[e].mode&&(n+='<span class="text-muted">deaktiviert</span>'),"enabled"==t[e].mode&&(n+="aktiviert (minimum Leistung)"),"follow"==t[e].mode&&(n+="Folgebetrieb Erzeugung"),"max"==t[e].mode&&(n+="Maximale Leistung"),n+="</td>",n+="</tr>");n+="</table>",$("#ladeMatrix").html(n)};$("#emob").modal(),$("#reqLoad").change((function(){$("#loadReq").html($("#reqLoad").val()),t()})),$("#reqHours").change((function(){$("#hoursReq").html(new Date((new Date).getTime()+36e5*$("#reqHours").val()).getHours()+":00"),$("#dminStr").html(new Date((new Date).getTime()+36e5*$("#reqHours").val()).toLocaleDateString()+"&nbsp;"),t()})),setTimeout((function(){t()}),500)})),$("#btnSchedule").show(),$("#btnLoadSchedule").show();let i='<table class="table table-sm table-responsive">';i+="<tr><th>Stunden</th><th>Einschalten</th><th>Ausschalten</th>",i+='<th colspan="12" align="left">',i+="jetzt",i+="</th>",i+='<th colspan="12" align="right" style="text-align:right">',i+=new Date((new Date).getTime()+864e5).toLocaleDateString(),i+=" "+new Date((new Date).getTime()+864e5).getHours()+":00",i+="</th>",i+="</tr>";for(let t=1;t<12;t++){let s=-999,a=0;for(let l=0;l<24;l++){let n=0;for(let s=0;s<t;s++)n+=e.stats.next24h.prodWh[l+s].nsi;n>s&&(s=n,a=e.stats.next24h.prodWh[l].time)}let l="<tr>";l+="<td>"+t+"</td>",l+="<td>"+new Date(a).toLocaleDateString()+" "+new Date(a).toLocaleTimeString()+"</td>",l+="<td>"+new Date(a+36e5*t).toLocaleDateString()+" "+new Date(a+36e5*t).toLocaleTimeString()+"</td>";for(let s=0;s<24&&s<e.stats.next24h.prodWh.length;s++)e.stats.next24h.prodWh[s].time>=a&&e.stats.next24h.prodWh[s].time<=a+36e5*t?l+="<td style='background:rgb(12,109,52);' title='"+new Date(e.stats.next24h.prodWh[s].time).toLocaleTimeString()+"'>&nbsp;</td>":l+="<td style='background:rgb(253,168,37);' title='"+new Date(e.stats.next24h.prodWh[s].time).toLocaleTimeString()+"'>&nbsp;</td>";l+="</tr>",i+=""+l}i+="</table>",$("#matrix").html(i)}else $("#btnSchedule").hide(),$("#btnLoadSchedule").hide(),$("#nsiChart").hide(),$("#rowNSI").hide(),$("#gsiChart").correntlyGSI(e.meterinfo.location.zip)}},a=function(){t=void 0!==window.localStorage.getItem("cid")&&null!==window.localStorage.getItem("cid")?"./p2p?method=msg&peer="+window.localStorage.getItem("cid"):"./msg",(e>20||0==e)&&$.getJSON(t,(function(t){window.localStorage.setItem("msg",JSON.stringify(t)),e=0,s()})).fail((function(){console.log("Switched to WAN Source"),$.getJSON("https://casa-corrently-demo.herokuapp.com/"+t,(function(t){window.localStorage.setItem("msg",JSON.stringify(t)),e=0,s()}))})),e++};a(),setInterval(a,9e5)}));