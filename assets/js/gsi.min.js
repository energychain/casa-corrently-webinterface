$(document).ready(function() {
    let msgurl = "./msg";
    let upd_singleton = 0;
    
   const render = function() {       
    if((typeof window.localStorage.getItem('msg') !== 'undefined') && (window.localStorage.getItem('msg') !== null)) {
        let data = JSON.parse(window.localStorage.getItem('msg'));    
        $('#gsiChart').correntlyGSI(data.meterinfo.location.zip);         
        if(typeof data.depot !== "undefined") {
            $('#gsbInfo').correntlySKOBalance(data.depot.account);
            $('#depot').correntlySKODepot(data.depot.account);
            $('#customsko').correntlyTreeBalance(data.depot.account);
            $('#hknchart').correntlyHKNChart(data.meterinfo.location.zip);
        }
        
        let daterow = '<tr><td class='small'>&#128197;</td>'
        let barrow = '<tr><td class='small'>&nbsp;</td>';
        
        for(var i=0;(i<data.stats.next24h.prodWh.length);i++) {
            let date = new Date(data.stats.next24h.prodWh[i].time);
            if((i==0)||(date.getHours()==0)) {
                daterow+="<td class='small tsclass' colspan='3'>"+date.getDate()+"."+(date.getMonth()+1)+"</td>";
             } else daterow+="<td>&nbsp;</td>";   
            let bgclass="bg-warning";
            if(data.forecast[i].gsi<48) bgclass="bg-secondary";
            if(data.forecast[i].gsi>52) bgclass="bg-success";
            barrow+="<td style='vertical-align:bottom' class='tsclass'><div class='"+bgclass+"' title='Indexwert: "+data.stats.next24h.prodWh[i].nsi+" Punkte' style=';height:"+Math.round((data.stats.next24h.prodWh[i].nsi)*2)+"px'></div></td>";
        }
        
        daterow+="</tr>";
        barrow+="</tr>";
        $('#nsiChart').html("<table class='table table-sm table-responsive gsiDataGiven'>"+barrow+daterow+"</table>");
    }      
   };
       
    const update = function() { 
       
    if((typeof window.localStorage.getItem('cid') !== 'undefined') &&(window.localStorage.getItem('cid')!==null)){
        msgurl='./p2p?method=msg&peer='+window.localStorage.getItem('cid');
    } else {
        msgurl='./msg';
    }       
       if((upd_singleton > 20) || (upd_singleton==0)) {
          
           $.getJSON(msgurl,function(data) {       
               window.localStorage.setItem('msg',JSON.stringify(data));
               upd_singleton=0;
               render();
           });     
       }
        upd_singleton++;
   }
   
   update();
   setInterval(update,900000);
})